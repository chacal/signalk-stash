version: 2.1
commands:
  build:
    description: 'Build & start project dependencies'
    steps:
      - checkout
      - restore_cache:
          keys:
            - v1-signal-k-stash-{{ checksum "package.json" }}
      - run:
          command: npm install
      - save_cache:
          key: v1-signal-k-stash-{{ checksum "package.json" }}
          paths:
            - ~/.cache
            - ~/.npm
      - run:
          command: make docker-test-up
      - run:
          name: 'Wait for dependencies to start up'
          command: npx wait-on -w 2000 tcp:45432 && npx wait-on -w 2000 tcp:41883

jobs:
  unit-test:
    machine: true
    steps:
      - build
      - run:
          command: make test
      - store_test_results:
          path: test_reports

  integration-test:
    machine: true
    steps:
      - build
      - run:
          command: make start-test
          background: true
      - run:
          name: 'Wait for test server to start'
          command: npx wait-on "http://localhost:43000/tracks?context=self"
      - run:
          command: make test-integration
      - store_test_results:
          path: test_reports

  build-containers:
    machine: true
    steps:
      - checkout
      - run:
          name: Build api-server container
          command: make docker-build-apiserver
      - run:
          name: Build mqtt-input container
          command: make docker-build-mqtt-input
      - run:
          name: Push containers to Docker Hub
          command: |
            echo ${DOCKERHUB_PASSWORD} | docker login -u ${DOCKERHUB_USERNAME} --password-stdin
            TAG=build-${CIRCLE_BUILD_NUM} make docker-tag-and-push-apiserver
            TAG=build-${CIRCLE_BUILD_NUM} make docker-tag-and-push-mqtt-input

workflows:
  version: 2
  test-and-build:
    jobs:
      - unit-test
      - integration-test
      - build-containers:
          requires:
            - unit-test
            - integration-test
          filters:
            branches:
              only: prod